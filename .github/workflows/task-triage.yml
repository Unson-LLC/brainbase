name: é€±æ¬¡ã‚¿ã‚¹ã‚¯æ£šå¸ã—

on:
  schedule:
    # æ¯é€±æ—¥æ›œ 09:00 JST = 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  triage:
    runs-on: [self-hosted, local]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Claude Code environment
        run: |
          mkdir -p ~/.claude
          echo '{"hasCompletedOnboarding": true}' > ~/.claude.json

      - name: Collect task data
        id: collect
        run: |
          # ã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’åé›†
          node -e "
            const fs = require('fs');
            const content = fs.readFileSync('_tasks/index.md', 'utf-8');
            const blocks = content.split(/^---$/m).filter(b => b.trim());
            const tasks = [];
            for (let i = 0; i < blocks.length; i += 2) {
              const yaml = blocks[i];
              if (!yaml.includes('ä½è—¤')) continue;
              if (yaml.includes('status: done')) continue;
              const title = (yaml.match(/^title:\s*(.+)$/m) || [])[1] || '(ç„¡é¡Œ)';
              const project = (yaml.match(/^project_id:\s*(.+)$/m) || [])[1] || 'general';
              const priority = (yaml.match(/^priority:\s*(.+)$/m) || [])[1] || 'medium';
              tasks.push('- [' + project + '] ' + title + ' (' + priority + ')');
            }
            console.log(tasks.join('\n'));
          " > /tmp/tasks.txt

          # ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’åé›†
          node -e "
            const fs = require('fs');
            const content = fs.readFileSync('_codex/common/meta/people.md', 'utf-8');
            const members = [];
            for (const line of content.split('\n')) {
              if (!line.startsWith('|') || line.includes('---') || line.includes('åå‰')) continue;
              const cells = line.split('|').map(c => c.trim()).filter(c => c);
              if (cells.length >= 5 && cells[4].includes('ç¨¼åƒä¸­') && !cells[1].includes('Stakeholder')) {
                members.push('- ' + cells[0] + ': ' + cells[1] + ' (' + cells[3] + ')');
              }
            }
            console.log(members.slice(0, 15).join('\n'));
          " > /tmp/members.txt

          echo "ã‚¿ã‚¹ã‚¯æ•°: $(wc -l < /tmp/tasks.txt)"
          echo "ãƒ¡ãƒ³ãƒãƒ¼æ•°: $(wc -l < /tmp/members.txt)"

      - name: Run Claude Code analysis
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          TASKS=$(cat /tmp/tasks.txt)
          MEMBERS=$(cat /tmp/members.txt)

          cat > /tmp/prompt.txt << 'PROMPT_END'
          ä½è—¤åœ­å¾ã®ã‚¿ã‚¹ã‚¯æ£šå¸ã—ã‚’è¡Œã„ã¾ã™ã€‚

          ## ã‚¿ã‚¹ã‚¯ä¸€è¦§
          PROMPT_END
          echo "$TASKS" >> /tmp/prompt.txt
          cat >> /tmp/prompt.txt << 'PROMPT_END'

          ## å§”ä»»å…ˆå€™è£œãƒ¡ãƒ³ãƒãƒ¼
          PROMPT_END
          echo "$MEMBERS" >> /tmp/prompt.txt
          cat >> /tmp/prompt.txt << 'PROMPT_END'

          ä»¥ä¸‹ã®3ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã—ã¦ãã ã•ã„ï¼š
          - ğŸ”µ ä½è—¤ãŒã‚„ã‚‹ã¹ãï¼ˆæˆ¦ç•¥çš„æ„æ€æ±ºå®šã€æŠ€è¡“è¨­è¨ˆã€ä»•çµ„ã¿ã¥ãã‚Šï¼‰
          - ğŸŸ¡ å§”ä»»ã™ã¹ãï¼ˆå®šå‹ä½œæ¥­ã€è³‡æ–™ä½œæˆã€èª¿æŸ»ã€å®Ÿè£…ï¼‰
          - ğŸ”´ æ¨ã¦ã‚‹ã¹ãï¼ˆæœŸé™åˆ‡ã‚Œã€ä¸è¦ã«ãªã£ãŸã‚‚ã®ï¼‰

          å„ã‚¿ã‚¹ã‚¯ã‚’ä»¥ä¸‹ã®å½¢å¼ã§åˆ†é¡ï¼š
          ğŸ”µ/ğŸŸ¡/ğŸ”´ [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ] ã‚¿ã‚¹ã‚¯å
            â†’ ç†ç”±ï¼ˆ1è¡Œï¼‰
            â†’ å§”ä»»å…ˆå€™è£œ: åå‰ï¼ˆå§”ä»»ã®å ´åˆã®ã¿ï¼‰

          æœ€å¾Œã«ã‚µãƒãƒªã‚’å‡ºåŠ›ã€‚å…¨ä½“ã§1500æ–‡å­—ä»¥å†…ã€‚
          PROMPT_END

          # stdinã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã—ã¦å®Ÿè¡Œ
          cat /tmp/prompt.txt | claude --print > /tmp/analysis.txt 2>&1 || echo "AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ" > /tmp/analysis.txt

          echo "=== åˆ†æçµæœ ==="
          cat /tmp/analysis.txt

      - name: Send to Slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          ANALYSIS=$(cat /tmp/analysis.txt)
          DATE=$(date '+%Y/%m/%d (%a)')

          node -e "
            const https = require('https');
            const analysis = process.argv[1];
            const date = process.argv[2];
            const body = {
              channel: 'U07LNUP582X',
              text: 'é€±æ¬¡ã‚¿ã‚¹ã‚¯æ£šå¸ã—ãƒ¬ãƒãƒ¼ãƒˆ',
              blocks: [
                { type: 'header', text: { type: 'plain_text', text: 'ğŸ“‹ é€±æ¬¡ã‚¿ã‚¹ã‚¯æ£šå¸ã—ãƒ¬ãƒãƒ¼ãƒˆ', emoji: true }},
                { type: 'context', elements: [{ type: 'mrkdwn', text: 'ğŸ“… ' + date }]},
                { type: 'divider' },
                { type: 'section', text: { type: 'mrkdwn', text: analysis.slice(0, 2800) }}
              ]
            };
            const req = https.request({
              hostname: 'slack.com',
              path: '/api/chat.postMessage',
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + process.env.SLACK_BOT_TOKEN,
                'Content-Type': 'application/json'
              }
            }, res => {
              let data = '';
              res.on('data', c => data += c);
              res.on('end', () => {
                const result = JSON.parse(data);
                console.log(result.ok ? 'âœ… Slacké€ä¿¡å®Œäº†' : 'âŒ Slacké€ä¿¡å¤±æ•—: ' + result.error);
              });
            });
            req.write(JSON.stringify(body));
            req.end();
          " "$ANALYSIS" "$DATE"
