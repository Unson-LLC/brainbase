name: Update mana Signing Secret

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: self-hosted
    steps:
      - name: Update mana Lambda SLACK_SIGNING_SECRET
        env:
          SLACK_SIGNING_SECRET: ${{ secrets.SLACK_SIGNING_SECRET }}
        run: |
          echo "=== Updating mana Lambda SLACK_SIGNING_SECRET ==="

          # Get current environment variables
          CURRENT_VARS=$(aws lambda get-function-configuration \
            --function-name mana \
            --region us-east-1 \
            --profile k.sato \
            --query 'Environment.Variables' \
            --output json)

          # Update SLACK_SIGNING_SECRET
          echo "$CURRENT_VARS" | jq --arg secret "$SLACK_SIGNING_SECRET" '{Variables: (. | .SLACK_SIGNING_SECRET = $secret)}' > /tmp/mana-env.json

          # Update Lambda function
          aws lambda update-function-configuration \
            --function-name mana \
            --region us-east-1 \
            --profile k.sato \
            --environment file:///tmp/mana-env.json \
            > /dev/null

          rm -f /tmp/mana-env.json

          echo "âœ… Updated mana Lambda SLACK_SIGNING_SECRET"

          # Test with a simple event
          echo ""
          echo "=== Checking recent logs ==="
          sleep 2
          aws logs tail /aws/lambda/mana --since 1m --format short --profile k.sato --region us-east-1 2>&1 | grep -i "signature\|error" | tail -5 || echo "No recent errors"
