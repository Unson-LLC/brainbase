name: Fetch X Bookmarks

on:
  schedule:
    # 毎日 6:00 JST (21:00 UTC 前日)
    - cron: '0 21 * * *'
  workflow_dispatch:  # 手動実行用

env:
  PYTHON_VERSION: '3.11'

jobs:
  fetch-bookmarks:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # リポジトリへのコミット用

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install requests

      - name: Restore token
        env:
          TOKEN_KEY: ${{ secrets.X_TOKEN_KEY }}
        run: |
          # 暗号化ファイルがあれば復号、なければSecretから
          TOKEN_FILE="_codex/common/ops/scripts/.x_oauth2_token.json.enc"
          if [ -f "$TOKEN_FILE" ] && [ -n "$TOKEN_KEY" ]; then
            echo "Decrypting token from repo..."
            openssl enc -aes-256-cbc -d -pbkdf2 -in "$TOKEN_FILE" -out /tmp/x_oauth2_token.json -pass pass:"$TOKEN_KEY"
          else
            echo "Using token from secret..."
            echo '${{ secrets.X_OAUTH_TOKEN }}' > /tmp/x_oauth2_token.json
          fi

      - name: Fetch bookmarks
        id: fetch
        env:
          X_CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          X_CLIENT_SECRET: ${{ secrets.X_CLIENT_SECRET }}
          X_TOKEN_FILE: /tmp/x_oauth2_token.json
        run: |
          python _codex/common/ops/scripts/x_oauth2_actions.py \
            --bookmarks 100 \
            --json \
            --output _codex/sources/global/x_bookmarks/cache/latest.json

      - name: Encrypt updated token
        env:
          TOKEN_KEY: ${{ secrets.X_TOKEN_KEY }}
        run: |
          if [ -n "$TOKEN_KEY" ]; then
            openssl enc -aes-256-cbc -pbkdf2 -in /tmp/x_oauth2_token.json -out _codex/common/ops/scripts/.x_oauth2_token.json.enc -pass pass:"$TOKEN_KEY"
            echo "Token encrypted"
          else
            echo "::warning::X_TOKEN_KEY not set - token will not be persisted"
          fi

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 変更をステージング
          git add _codex/sources/global/x_bookmarks/cache/latest.json
          git add _codex/common/ops/scripts/.x_oauth2_token.json.enc 2>/dev/null || true

          # 変更があればコミット
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: X Bookmarks自動取得 ($(date +%Y-%m-%d))"
            git push
          fi

      - name: Cleanup
        if: always()
        run: rm -f /tmp/x_oauth2_token.json
