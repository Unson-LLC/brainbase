name: Actions Healthcheck

on:
  workflow_dispatch:
  schedule:
    - cron: '0,30 0-14 * * *'  # JST 09:00-23:00

permissions:
  contents: read
  actions: read
  # runner監視は後段でPAT化した際にadministrationも付与予定

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    env:
      REPOS: |
        sintariran/brainbase
      MAX_AGE_HOURS: "24"
    steps:
      - name: Check workflows (failures only)
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const repos = process.env.REPOS.trim().split(/\s+/);
            const maxAgeHours = Number(process.env.MAX_AGE_HOURS || 24);
            const maxAgeMs = maxAgeHours * 60 * 60 * 1000;
            const now = Date.now();
            const issues = [];

            for (const repo of repos) {
              const [owner, name] = repo.split('/');
              const runs = await github.paginate(
                github.rest.actions.listWorkflowRunsForRepo,
                { owner, repo: name, per_page: 50, status: 'completed', exclude_pull_requests: true }
              );
              const recentFailed = runs.find(
                (r) => r.conclusion !== 'success' &&
                       (now - new Date(r.created_at).getTime()) <= maxAgeMs
              );
              if (recentFailed) {
                issues.push({
                  repo,
                  workflow: recentFailed.name,
                  html_url: recentFailed.html_url,
                  conclusion: recentFailed.conclusion,
                  created_at: recentFailed.created_at,
                });
              }
            }

            core.setOutput('has_issues', issues.length > 0 ? 'true' : 'false');
            core.setOutput('issues', JSON.stringify(issues));
            core.setOutput('issues_text', issues.map(i => `• ${i.repo}: ${i.workflow} (${i.conclusion}) -> ${i.html_url}`).join('\n'));

      - name: No issues found
        if: steps.check.outputs.has_issues != 'true'
        run: echo "No failed workflows in the last ${MAX_AGE_HOURS}h."

      - name: Notify Slack (issues only)
        if: steps.check.outputs.has_issues == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          ISSUES_TEXT: ${{ steps.check.outputs.issues_text }}
        run: |
          text="[Actions Healthcheck]\n❌ Failed workflows (24h):\n${ISSUES_TEXT}"

          if [ -n "$SLACK_BOT_TOKEN" ] && [ -n "$SLACK_CHANNEL_ID" ]; then
            curl -sS -X POST https://slack.com/api/chat.postMessage \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H 'Content-type: application/json; charset=utf-8' \
              --data "$(jq -n --arg channel "$SLACK_CHANNEL_ID" --arg text "$text" '{channel:$channel,text:$text}')"
          elif [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -sS -X POST -H 'Content-type: application/json' --data "$(jq -Rn --arg t "$text" '{text: $t}')" "$SLACK_WEBHOOK_URL"
          else
            echo "No Slack config; skipping notification."
          fi
