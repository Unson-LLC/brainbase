name: Update mana Workspace Credentials

on:
  workflow_dispatch:
    inputs:
      lambda_function:
        description: 'Lambda function to update'
        required: true
        type: choice
        options:
          - mana
          - mana-salestailor
          - mana-techknight
      slack_bot_token:
        description: 'SLACK_BOT_TOKEN (xoxb-...)'
        required: true
        type: string
      slack_signing_secret:
        description: 'SLACK_SIGNING_SECRET'
        required: true
        type: string

jobs:
  update:
    runs-on: self-hosted
    steps:
      - name: Validate inputs
        run: |
          if [[ ! "${{ inputs.slack_bot_token }}" =~ ^xoxb- ]]; then
            echo "❌ Error: SLACK_BOT_TOKEN must start with 'xoxb-'"
            exit 1
          fi

          if [ ${#{{ inputs.slack_signing_secret }}} -ne 32 ]; then
            echo "❌ Error: SLACK_SIGNING_SECRET must be 32 characters"
            exit 1
          fi

          echo "✅ Input validation passed"

      - name: Backup current configuration
        run: |
          # タイムスタンプ付きバックアップファイル（aws-lambda-env-update.md 準拠）
          BACKUP_FILE="/tmp/env_backup_$(date +%Y%m%d_%H%M%S).json"

          aws lambda get-function-configuration \
            --function-name ${{ inputs.lambda_function }} \
            --region us-east-1 \
            --profile k.sato \
            --query 'Environment' \
            --output json > "$BACKUP_FILE"

          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV
          echo "✅ Configuration backed up to: $BACKUP_FILE"

      - name: Test new credentials
        env:
          SLACK_BOT_TOKEN: ${{ inputs.slack_bot_token }}
        run: |
          echo "=== Testing new SLACK_BOT_TOKEN ==="
          AUTH_RESULT=$(curl -sS "https://slack.com/api/auth.test" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN")

          if [ "$(echo "$AUTH_RESULT" | jq -r '.ok')" != "true" ]; then
            echo "❌ Error: Invalid SLACK_BOT_TOKEN"
            echo "$AUTH_RESULT" | jq '.'
            exit 1
          fi

          echo "Workspace: $(echo "$AUTH_RESULT" | jq -r '.team') ($(echo "$AUTH_RESULT" | jq -r '.team_id'))"
          echo "Bot User: $(echo "$AUTH_RESULT" | jq -r '.user')"

          # Store for later comparison
          echo "$AUTH_RESULT" | jq '{team, team_id, user, user_id}' > /tmp/auth-result.json
          echo "✅ Credentials validated"

      - name: Prepare updated configuration
        env:
          SLACK_BOT_TOKEN: ${{ inputs.slack_bot_token }}
          SLACK_SIGNING_SECRET: ${{ inputs.slack_signing_secret }}
        run: |
          # ファイルベース更新（aws-lambda-env-update.md 準拠）
          UPDATED_FILE="/tmp/env_updated.json"

          # バックアップから更新版を作成
          jq \
            --arg bot_token "$SLACK_BOT_TOKEN" \
            --arg signing_secret "$SLACK_SIGNING_SECRET" \
            '.Variables.SLACK_BOT_TOKEN = $bot_token | .Variables.SLACK_SIGNING_SECRET = $signing_secret' \
            "$BACKUP_FILE" > "$UPDATED_FILE"

          echo "UPDATED_FILE=$UPDATED_FILE" >> $GITHUB_ENV
          echo "✅ Updated configuration prepared"

      - name: Review changes (diff)
        run: |
          # 変更内容を確認（aws-lambda-env-update.md 必須ステップ）
          echo "=== Reviewing changes ==="
          diff <(jq -S . "$BACKUP_FILE") <(jq -S . "$UPDATED_FILE") || true

          echo ""
          echo "=== Keys in updated configuration ==="
          jq '.Variables | keys' "$UPDATED_FILE"

      - name: Apply update
        run: |
          # 更新適用（file:// プロトコル使用）
          aws lambda update-function-configuration \
            --function-name ${{ inputs.lambda_function }} \
            --region us-east-1 \
            --profile k.sato \
            --environment "file://$UPDATED_FILE"

          echo "✅ Lambda environment variables updated"

      - name: Verify update
        run: |
          echo "=== Waiting for Lambda update to complete ==="
          sleep 5

          # 更新後のキー確認（aws-lambda-env-update.md 必須ステップ）
          aws lambda get-function-configuration \
            --function-name ${{ inputs.lambda_function }} \
            --region us-east-1 \
            --profile k.sato \
            --query 'Environment.Variables' \
            --output json > /tmp/env_after_update.json

          echo "=== Keys after update ==="
          jq 'keys' /tmp/env_after_update.json

          # 全ての元のキーが存在するか確認
          BEFORE_KEYS=$(jq -r '.Variables | keys[]' "$BACKUP_FILE" | sort)
          AFTER_KEYS=$(jq -r 'keys[]' /tmp/env_after_update.json | sort)

          if [ "$BEFORE_KEYS" != "$AFTER_KEYS" ]; then
            echo "❌ Error: Environment variable keys changed!"
            echo "Before: $BEFORE_KEYS"
            echo "After: $AFTER_KEYS"
            exit 1
          fi

          # トークンを取得してワークスペース検証
          jq -r '.SLACK_BOT_TOKEN' /tmp/env_after_update.json > /tmp/new_token.txt
          NEW_TOKEN=$(cat /tmp/new_token.txt)

          # API検証
          curl -sS "https://slack.com/api/auth.test" \
            -H "Authorization: Bearer $NEW_TOKEN" > /tmp/auth_after_update.json

          echo ""
          echo "Updated workspace: $(jq -r '.team' /tmp/auth_after_update.json) ($(jq -r '.team_id' /tmp/auth_after_update.json))"

          # 期待値との比較
          EXPECTED=$(cat /tmp/auth-result.json)
          ACTUAL=$(jq '{team, team_id, user, user_id}' /tmp/auth_after_update.json)

          if [ "$EXPECTED" != "$ACTUAL" ]; then
            echo "❌ Error: Verification failed"
            echo "Expected: $EXPECTED"
            echo "Actual: $ACTUAL"
            exit 1
          fi

          echo "✅ Update verified successfully"

      - name: Test Slack event handling
        run: |
          echo "=== Checking recent Lambda logs ==="
          sleep 3

          # ログをファイルに保存してからチェック（コマンド置換回避）
          aws logs tail /aws/lambda/${{ inputs.lambda_function }} \
            --since 2m \
            --format short \
            --profile k.sato \
            --region us-east-1 2>&1 > /tmp/recent_logs.txt || true

          # 署名エラーをチェック
          grep -i "Invalid request signature" /tmp/recent_logs.txt > /tmp/signature_errors.txt || true
          ERROR_COUNT=$(wc -l < /tmp/signature_errors.txt | tr -d ' ')

          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "⚠️ Warning: Found $ERROR_COUNT signature errors in recent logs"
            echo "This is normal if the update just completed. Test with a Slack mention."
          else
            echo "✅ No signature errors detected"
          fi

      - name: Summary
        run: |
          # ファイルから値を読み取り（コマンド置換回避）
          jq -r '.team' /tmp/auth-result.json > /tmp/workspace_name.txt
          jq -r '.team_id' /tmp/auth-result.json > /tmp/team_id.txt
          jq -r '.user' /tmp/auth-result.json > /tmp/bot_user.txt

          WORKSPACE_NAME=$(cat /tmp/workspace_name.txt)
          TEAM_ID=$(cat /tmp/team_id.txt)
          BOT_USER=$(cat /tmp/bot_user.txt)

          echo ""
          echo "=== Update Summary ==="
          echo "Lambda: ${{ inputs.lambda_function }}"
          echo "Workspace: $WORKSPACE_NAME"
          echo "Team ID: $TEAM_ID"
          echo "Bot User: $BOT_USER"
          echo ""
          echo "✅ Credentials updated successfully"
          echo ""
          echo "Next steps:"
          echo "1. Test with a Slack mention to @mana in the updated workspace"
          echo "2. Check CloudWatch logs for any errors"
          echo "3. Backup file: $BACKUP_FILE"
