name: manaè‡ªå·±æ”¹å–„ (LLM-as-Judge)

# GitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•å“è³ªæ”¹å–„
on:
  schedule:
    # æ¯æ—¥22:00 JST (13:00 UTC) ã«å®Ÿè¡Œ
    - cron: '0 13 * * *'
  workflow_dispatch:
    inputs:
      target_date:
        description: 'è©•ä¾¡å¯¾è±¡æ—¥ (YYYY-MM-DD)ã€‚ç©ºæ¬„ã§å‰æ—¥'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  evaluate-and-improve:
    runs-on: self-hosted

    steps:
      - name: Setup workspace
        run: |
          # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          WORK_DIR="/tmp/mana-improve-$(date +%s)"
          mkdir -p "$WORK_DIR"
          echo "WORK_DIR=$WORK_DIR" >> $GITHUB_ENV

          # manaãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ï¼‰
          git clone https://github.com/Unson-LLC/slack-classify-bot.git "$WORK_DIR/mana"
          echo "MANA_PATH=$WORK_DIR/mana" >> $GITHUB_ENV

      - name: Set target date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            echo "date=${{ github.event.inputs.target_date }}" >> $GITHUB_OUTPUT
          else
            # å‰æ—¥ã®æ—¥ä»˜ (JST)
            echo "date=$(TZ=Asia/Tokyo date -v-1d +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

      - name: Download mana conversations from S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
        run: |
          TARGET_DATE="${{ steps.date.outputs.date }}"
          mkdir -p "$WORK_DIR/judge"

          # å„ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          for workspace in unson salestailor techknight; do
            S3_KEY="slack/${workspace}/mana-conversations/${TARGET_DATE}.json"
            aws s3 cp "s3://brainbase-context-593793022993/${S3_KEY}" \
              "$WORK_DIR/judge/${workspace}_${TARGET_DATE}.json" 2>/dev/null || true
          done

          # å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
          echo "=== Downloaded files ==="
          ls -la "$WORK_DIR/judge/"

      - name: Check if conversations exist
        id: check
        run: |
          FILE_COUNT=$(ls "$WORK_DIR/judge/"*.json 2>/dev/null | wc -l | tr -d ' ')
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No conversations found for ${{ steps.date.outputs.date }}"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            TOTAL=$(cat "$WORK_DIR/judge/"*.json 2>/dev/null | jq -s 'map(.messages) | flatten | length' || echo 0)
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "Found $TOTAL conversations"

            # ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’è¡¨ç¤º
            echo "=== Conversation Data ==="
            cat "$WORK_DIR/judge/"*.json | jq -r '.messages[] | "[\(.user_name)] \(.user_message)\n[mana] \(.mana_response)\n---"' | head -100
          fi

      - name: Setup Claude Code environment
        if: steps.check.outputs.skip != 'true'
        run: |
          mkdir -p ~/.claude
          echo '{"hasCompletedOnboarding": true}' > ~/.claude.json

      - name: Run Claude Code for evaluation and improvement
        if: steps.check.outputs.skip != 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          TARGET_DATE: ${{ steps.date.outputs.date }}
          PROMPT_TEMPLATE: |
            # manaå¿œç­”å“è³ªè©•ä¾¡ã¨æ”¹å–„ã‚¿ã‚¹ã‚¯

            ã‚ãªãŸã¯manaï¼ˆSlack Botï¼‰ã®å“è³ªæ”¹å–„æ‹…å½“AIã§ã™ã€‚
            ä»¥ä¸‹ã®ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’è©•ä¾¡ã—ã€å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¼ãƒ‰ã‚’æ”¹å–„ã—ã¦ãã ã•ã„ã€‚

            ## è©•ä¾¡å¯¾è±¡ã®ä¼šè©±ãƒ‡ãƒ¼ã‚¿ (__TARGET_DATE__)

            ```json
            __CONVERSATIONS__
            ```

            ## ã‚¿ã‚¹ã‚¯

            ### 1. è©•ä¾¡ (LLM-as-Judge)
            å„ä¼šè©±ã‚’ä»¥ä¸‹ã®è¦³ç‚¹ã§1-5ã‚¹ã‚³ã‚¢ã§è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š
            - æœ‰ç”¨æ€§: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã«å¯¾ã—ã¦æœ‰ç”¨ãªå›ç­”ã‹
            - æ­£ç¢ºæ€§: äº‹å®Ÿã«åŸºã¥ã„ãŸæ­£ç¢ºãªæƒ…å ±ã‹
            - ç°¡æ½”æ€§: å†—é•·ã§ãªãé©åˆ‡ãªé•·ã•ã‹
            - ãƒˆãƒ¼ãƒ³: é©åˆ‡ãªãƒˆãƒ¼ãƒ³ã‹

            ### 2. å•é¡Œç‰¹å®šã¨æ”¹å–„
            ã‚¹ã‚³ã‚¢ãŒ3ä»¥ä¸‹ã®ä¼šè©±ãŒã‚ã‚Œã°ï¼š
            1. å•é¡Œç‚¹ã‚’ç‰¹å®š
            2. api/index.js ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£

            ### 3. ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
            è©•ä¾¡çµæœã‚’ __WORK_DIR__/judge/report.json ã«å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
            ```json
            {
              "date": "__TARGET_DATE__",
              "total_conversations": N,
              "evaluations": [
                {"id": "...", "scores": {"usefulness": N, "accuracy": N, "conciseness": N, "tone": N}, "issues": "..."}
              ],
              "average_scores": {"usefulness": N, "accuracy": N, "conciseness": N, "tone": N},
              "changes_made": ["å¤‰æ›´å†…å®¹ã®èª¬æ˜"]
            }
            ```

            ## é‡è¦ãªæ³¨æ„äº‹é …
            - CLAUDE.mdã‚„ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç„¡è¦–ã—ã¦ãã ã•ã„
            - è©•ä¾¡å¯¾è±¡ã¯ä¸Šè¨˜ã®ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§ã™
            - æ”¹å–„ãŒä¸è¦ãªå ´åˆï¼ˆå…¨ã¦ã‚¹ã‚³ã‚¢4ä»¥ä¸Šï¼‰ã¯ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãªã„ã§ãã ã•ã„
            - å¤‰æ›´ã™ã‚‹å ´åˆã¯æœ€å°é™ã«ç•™ã‚ã¦ãã ã•ã„
        working-directory: ${{ env.MANA_PATH }}
        run: |
          # ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
          CONVERSATIONS=$(cat "$WORK_DIR/judge/"*.json | jq -s 'map(.messages) | flatten')

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰ï¼‰
          echo "$PROMPT_TEMPLATE" > "$WORK_DIR/prompt.txt"

          # å¤‰æ•°ã‚’ç½®æ›
          sed -i.bak "s|__TARGET_DATE__|${TARGET_DATE}|g" "$WORK_DIR/prompt.txt"
          sed -i.bak "s|__WORK_DIR__|${WORK_DIR}|g" "$WORK_DIR/prompt.txt"

          # ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
          echo "$CONVERSATIONS" > "$WORK_DIR/conversations.tmp"
          awk '
            /__CONVERSATIONS__/ {
              while ((getline line < "'"$WORK_DIR"'/conversations.tmp") > 0) {
                print line
              }
              close("'"$WORK_DIR"'/conversations.tmp")
              next
            }
            { print }
          ' "$WORK_DIR/prompt.txt" > "$WORK_DIR/prompt.txt.new"
          mv "$WORK_DIR/prompt.txt.new" "$WORK_DIR/prompt.txt"
          rm -f "$WORK_DIR/conversations.tmp" "$WORK_DIR/prompt.txt.bak"

          # Claude Codeã‚’å®Ÿè¡Œ
          cat "$WORK_DIR/prompt.txt" | $HOME/.local/bin/claude --print

      - name: Check for changes
        if: steps.check.outputs.skip != 'true'
        id: changes
        working-directory: ${{ env.MANA_PATH }}
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by Claude Code"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "=== Changes ==="
            git diff --stat
            git diff
          fi

      - name: Create Pull Request
        if: steps.check.outputs.skip != 'true' && steps.changes.outputs.has_changes == 'true'
        working-directory: ${{ env.MANA_PATH }}
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_MONITOR_PAT }}
          TARGET_DATE: ${{ steps.date.outputs.date }}
        run: |
          BRANCH_NAME="mana-improve/${TARGET_DATE}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "fix(mana): LLM-as-Judge ã«ã‚ˆã‚‹æ”¹å–„ ($TARGET_DATE)

          Claude Code (Haiku) ãŒä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’è©•ä¾¡ã—ã€è‡ªå‹•æ”¹å–„ã‚’å®Ÿæ–½ã€‚

          Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude Haiku <noreply@anthropic.com>"

          git push -u origin "$BRANCH_NAME"

          # ãƒ¬ãƒãƒ¼ãƒˆã‚’PRã®bodyã«å«ã‚ã‚‹
          REPORT=""
          if [ -f "$WORK_DIR/judge/report.json" ]; then
            REPORT=$(cat "$WORK_DIR/judge/report.json" | jq -r '
              "### è©•ä¾¡ã‚µãƒãƒªãƒ¼\n" +
              "- å¹³å‡ã‚¹ã‚³ã‚¢: æœ‰ç”¨æ€§ \(.average_scores.usefulness // "N/A"), æ­£ç¢ºæ€§ \(.average_scores.accuracy // "N/A"), ç°¡æ½”æ€§ \(.average_scores.conciseness // "N/A"), ãƒˆãƒ¼ãƒ³ \(.average_scores.tone // "N/A")\n" +
              "- å¤‰æ›´å†…å®¹: \(.changes_made // [] | join(", "))"
            ' 2>/dev/null || echo "ãƒ¬ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—")
          fi

          gh pr create \
            --title "fix(mana): $TARGET_DATE ã®ä¼šè©±è©•ä¾¡ã«åŸºã¥ãæ”¹å–„" \
            --body "## Summary
          - å¯¾è±¡æ—¥: $TARGET_DATE
          - è©•ä¾¡æ¸ˆã¿ä¼šè©±æ•°: ${{ steps.check.outputs.total }}
          - Claude Code (Haiku) ã«ã‚ˆã‚‹è‡ªå‹•è©•ä¾¡ãƒ»æ”¹å–„

          $REPORT

          ## å¤‰æ›´å†…å®¹
          \`\`\`
          $(git diff HEAD~1 --stat)
          \`\`\`

          ---
          Generated with [Claude Code](https://claude.com/claude-code)" \
            --base main

      - name: Upload evaluation report to S3
        if: steps.check.outputs.skip != 'true'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
          TARGET_DATE: ${{ steps.date.outputs.date }}
        run: |
          if [ -f "$WORK_DIR/judge/report.json" ]; then
            # Upload to S3 for long-term storage and visualization
            aws s3 cp "$WORK_DIR/judge/report.json" \
              "s3://brainbase-context-593793022993/mana/quality-reports/${TARGET_DATE}.json" \
              --content-type "application/json"
            echo "âœ… Report uploaded to S3"
          else
            echo "âš ï¸ No report.json found"
          fi

      - name: Upload evaluation report (artifact)
        if: steps.check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-report-${{ steps.date.outputs.date }}
          path: ${{ env.WORK_DIR }}/judge/report.json
          if-no-files-found: ignore

      - name: Notify Slack with evaluation summary
        if: steps.check.outputs.skip != 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          TARGET_DATE: ${{ steps.date.outputs.date }}
        run: |
          if [ -f "$WORK_DIR/judge/report.json" ]; then
            # Parse report for summary
            SUMMARY=$(cat "$WORK_DIR/judge/report.json" | jq -r '
              "ğŸ“Š *manaå“è³ªè©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ* (\(.date))\n\n" +
              "è©•ä¾¡æ¸ˆã¿ä¼šè©±æ•°: \(.total_conversations)\n" +
              "å¹³å‡ã‚¹ã‚³ã‚¢:\n" +
              "  â€¢ æœ‰ç”¨æ€§: \(.average_scores.usefulness // "N/A")/5.0\n" +
              "  â€¢ æ­£ç¢ºæ€§: \(.average_scores.accuracy // "N/A")/5.0\n" +
              "  â€¢ ç°¡æ½”æ€§: \(.average_scores.conciseness // "N/A")/5.0\n" +
              "  â€¢ ãƒˆãƒ¼ãƒ³: \(.average_scores.tone // "N/A")/5.0\n\n" +
              if (.changes_made | length) > 0 then
                "ğŸ”§ æ”¹å–„å®Ÿæ–½: \(.changes_made | join(", "))"
              else
                "âœ… æ”¹å–„ä¸è¦ï¼ˆå…¨ã¦ã‚¹ã‚³ã‚¢4ä»¥ä¸Šï¼‰"
              end
            ' 2>/dev/null || echo "ãƒ¬ãƒãƒ¼ãƒˆè§£æå¤±æ•—")

            if [ -n "$SLACK_BOT_TOKEN" ] && [ -n "$SLACK_CHANNEL_ID" ]; then
              curl -sS -X POST https://slack.com/api/chat.postMessage \
                -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                -H 'Content-type: application/json; charset=utf-8' \
                --data "$(jq -n --arg channel "$SLACK_CHANNEL_ID" --arg text "$SUMMARY" '{channel:$channel,text:$text}')"
              echo "âœ… Slack notification sent"
            fi
          fi

      - name: Deploy dashboard to S3
        if: steps.check.outputs.skip != 'true'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
        working-directory: ${{ env.MANA_PATH }}
        run: |
          if [ -f "dashboard/quality-dashboard.html" ]; then
            aws s3 cp dashboard/quality-dashboard.html \
              "s3://brainbase-context-593793022993/mana/dashboard/index.html" \
              --content-type "text/html" \
              --cache-control "no-cache"
            echo "âœ… Dashboard deployed to S3"
            echo "ğŸ“Š Dashboard URL: https://brainbase-context-593793022993.s3.us-east-1.amazonaws.com/mana/dashboard/index.html"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -rf "$WORK_DIR" 2>/dev/null || true
