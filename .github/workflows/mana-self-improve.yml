name: mana自己改善 (LLM-as-Judge)

# GitHub Actionsによる自動品質改善
on:
  schedule:
    # テスト実行: 05:38 UTC (14:38 JST) - 元: 13:00 UTC (22:00 JST)
    - cron: '38 5 * * *'
  workflow_dispatch:
    inputs:
      target_date:
        description: '評価対象日 (YYYY-MM-DD)。空欄で前日'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  evaluate-and-improve:
    runs-on: self-hosted

    steps:
      - name: Setup workspace
        run: |
          # 作業ディレクトリを作成
          WORK_DIR="/tmp/mana-improve-$(date +%s)"
          mkdir -p "$WORK_DIR"
          echo "WORK_DIR=$WORK_DIR" >> $GITHUB_ENV

          # manaリポジトリをクローン（クリーンな状態で）
          git clone https://github.com/Unson-LLC/slack-classify-bot.git "$WORK_DIR/mana"
          echo "MANA_PATH=$WORK_DIR/mana" >> $GITHUB_ENV

      - name: Set target date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            echo "date=${{ github.event.inputs.target_date }}" >> $GITHUB_OUTPUT
          else
            # 前日の日付 (JST)
            echo "date=$(TZ=Asia/Tokyo date -v-1d +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

      - name: Download mana conversations from S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
        run: |
          TARGET_DATE="${{ steps.date.outputs.date }}"
          mkdir -p "$WORK_DIR/judge"

          # 各ワークスペースの会話データを取得
          for workspace in unson salestailor techknight; do
            S3_KEY="slack/${workspace}/mana-conversations/${TARGET_DATE}.json"
            aws s3 cp "s3://brainbase-context-593793022993/${S3_KEY}" \
              "$WORK_DIR/judge/${workspace}_${TARGET_DATE}.json" 2>/dev/null || true
          done

          # 取得したファイル一覧
          echo "=== Downloaded files ==="
          ls -la "$WORK_DIR/judge/"

      - name: Check if conversations exist
        id: check
        run: |
          FILE_COUNT=$(ls "$WORK_DIR/judge/"*.json 2>/dev/null | wc -l | tr -d ' ')
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No conversations found for ${{ steps.date.outputs.date }}"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            TOTAL=$(cat "$WORK_DIR/judge/"*.json 2>/dev/null | jq -s 'map(.messages) | flatten | length' || echo 0)
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "Found $TOTAL conversations"

            # 会話データの内容を表示
            echo "=== Conversation Data ==="
            cat "$WORK_DIR/judge/"*.json | jq -r '.messages[] | "[\(.user_name)] \(.user_message)\n[mana] \(.mana_response)\n---"' | head -100
          fi

      - name: Setup Claude Code environment
        if: steps.check.outputs.skip != 'true'
        run: |
          mkdir -p ~/.claude
          echo '{"hasCompletedOnboarding": true}' > ~/.claude.json

      - name: Run Claude Code for evaluation and improvement
        if: steps.check.outputs.skip != 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          TARGET_DATE: ${{ steps.date.outputs.date }}
          PROMPT_TEMPLATE: |
            # mana応答品質評価と改善タスク

            あなたはmana（Slack Bot）の品質改善担当AIです。
            以下の会話データを評価し、必要に応じてコードを改善してください。

            ## 評価対象の会話データ (__TARGET_DATE__)

            ```json
            __CONVERSATIONS__
            ```

            ## タスク

            ### 1. 評価 (LLM-as-Judge)
            各会話を以下の観点で1-5スコアで評価してください：
            - 有用性: ユーザーの意図に対して有用な回答か
            - 正確性: 事実に基づいた正確な情報か
            - 簡潔性: 冗長でなく適切な長さか
            - トーン: 適切なトーンか

            ### 2. 問題特定と改善
            スコアが3以下の会話があれば：
            1. 問題点を特定
            2. api/index.js のプロンプトやロジックを修正

            ### 3. レポート出力
            評価結果を __WORK_DIR__/judge/report.json に出力してください：
            ```json
            {
              "date": "__TARGET_DATE__",
              "total_conversations": N,
              "evaluations": [
                {"id": "...", "scores": {"usefulness": N, "accuracy": N, "conciseness": N, "tone": N}, "issues": "..."}
              ],
              "average_scores": {"usefulness": N, "accuracy": N, "conciseness": N, "tone": N},
              "changes_made": ["変更内容の説明"]
            }
            ```

            ## 重要な注意事項
            - CLAUDE.mdや他のシステムファイルは無視してください
            - 評価対象は上記の会話データのみです
            - 改善が不要な場合（全てスコア4以上）はコードを変更しないでください
            - 変更する場合は最小限に留めてください
        working-directory: ${{ env.MANA_PATH }}
        run: |
          # 会話データを読み込む
          CONVERSATIONS=$(cat "$WORK_DIR/judge/"*.json | jq -s 'map(.messages) | flatten')

          # プロンプトを作成（環境変数から）
          echo "$PROMPT_TEMPLATE" > "$WORK_DIR/prompt.txt"

          # 変数を置換
          sed -i.bak "s|__TARGET_DATE__|${TARGET_DATE}|g" "$WORK_DIR/prompt.txt"
          sed -i.bak "s|__WORK_DIR__|${WORK_DIR}|g" "$WORK_DIR/prompt.txt"

          # 会話データを挿入
          echo "$CONVERSATIONS" > "$WORK_DIR/conversations.tmp"
          awk '
            /__CONVERSATIONS__/ {
              while ((getline line < "'"$WORK_DIR"'/conversations.tmp") > 0) {
                print line
              }
              close("'"$WORK_DIR"'/conversations.tmp")
              next
            }
            { print }
          ' "$WORK_DIR/prompt.txt" > "$WORK_DIR/prompt.txt.new"
          mv "$WORK_DIR/prompt.txt.new" "$WORK_DIR/prompt.txt"
          rm -f "$WORK_DIR/conversations.tmp" "$WORK_DIR/prompt.txt.bak"

          # Claude Codeを実行
          cat "$WORK_DIR/prompt.txt" | $HOME/.local/bin/claude --print

      - name: Check for changes
        if: steps.check.outputs.skip != 'true'
        id: changes
        working-directory: ${{ env.MANA_PATH }}
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by Claude Code"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "=== Changes ==="
            git diff --stat
            git diff
          fi

      - name: Create Pull Request
        if: steps.check.outputs.skip != 'true' && steps.changes.outputs.has_changes == 'true'
        working-directory: ${{ env.MANA_PATH }}
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_MONITOR_PAT }}
          TARGET_DATE: ${{ steps.date.outputs.date }}
        run: |
          BRANCH_NAME="mana-improve/${TARGET_DATE}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "fix(mana): LLM-as-Judge による改善 ($TARGET_DATE)

          Claude Code (Haiku) が会話データを評価し、自動改善を実施。

          Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude Haiku <noreply@anthropic.com>"

          git push -u origin "$BRANCH_NAME"

          # レポートをPRのbodyに含める
          REPORT=""
          if [ -f "$WORK_DIR/judge/report.json" ]; then
            REPORT=$(cat "$WORK_DIR/judge/report.json" | jq -r '
              "### 評価サマリー\n" +
              "- 平均スコア: 有用性 \(.average_scores.usefulness // "N/A"), 正確性 \(.average_scores.accuracy // "N/A"), 簡潔性 \(.average_scores.conciseness // "N/A"), トーン \(.average_scores.tone // "N/A")\n" +
              "- 変更内容: \(.changes_made // [] | join(", "))"
            ' 2>/dev/null || echo "レポート読み込み失敗")
          fi

          gh pr create \
            --title "fix(mana): $TARGET_DATE の会話評価に基づく改善" \
            --body "## Summary
          - 対象日: $TARGET_DATE
          - 評価済み会話数: ${{ steps.check.outputs.total }}
          - Claude Code (Haiku) による自動評価・改善

          $REPORT

          ## 変更内容
          \`\`\`
          $(git diff HEAD~1 --stat)
          \`\`\`

          ---
          Generated with [Claude Code](https://claude.com/claude-code)" \
            --base main

      - name: Upload evaluation report
        if: steps.check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-report-${{ steps.date.outputs.date }}
          path: ${{ env.WORK_DIR }}/judge/report.json
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        run: |
          rm -rf "$WORK_DIR" 2>/dev/null || true
