name: Scheduled SNS Post

on:
  schedule:
    # æ¯æ™‚0åˆ†ã¨30åˆ†ã«ãƒã‚§ãƒƒã‚¯ï¼ˆUTCï¼‰
    # JST 09:00 = UTC 00:00, JST 12:00 = UTC 03:00, JST 21:00 = UTC 12:00
    - cron: '0,30 * * * *'
  workflow_dispatch:
    inputs:
      force_post_id:
        description: 'å¼·åˆ¶æŠ•ç¨¿ã™ã‚‹post IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        type: string
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆæŠ•ç¨¿ã›ãšã«ç¢ºèªï¼‰'
        type: boolean
        default: false
      list_ready:
        description: 'readyçŠ¶æ…‹ã®æŠ•ç¨¿ã‚’ä¸€è¦§è¡¨ç¤ºã®ã¿'
        type: boolean
        default: false

permissions:
  contents: write  # git pushç”¨

jobs:
  check-and-post:
    runs-on: self-hosted
    env:
      SCHEDULE_FILE: /Users/ksato/workspace/shared/_codex/sns/scheduled_posts.yml
      VENV_PYTHON: /Users/ksato/workspace/.venv/bin/python
      SCRIPT_PATH: /Users/ksato/workspace/shared/_codex/common/ops/scripts/scheduled_post_runner.py
    steps:
      - name: Check current time (JST)
        run: |
          echo "Current time (UTC): $(date -u)"
          echo "Current time (JST): $(TZ='Asia/Tokyo' date)"

      - name: List ready posts (if requested)
        if: inputs.list_ready == true
        run: |
          $VENV_PYTHON "$SCRIPT_PATH" \
            --schedule-file "$SCHEDULE_FILE" \
            --list-ready

      - name: Run scheduled post checker
        if: inputs.list_ready != true
        id: post
        run: |
          ARGS="--schedule-file $SCHEDULE_FILE"

          # å¼·åˆ¶æŠ•ç¨¿ID
          if [ -n "${{ inputs.force_post_id }}" ]; then
            ARGS="$ARGS --force-id ${{ inputs.force_post_id }}"
          fi

          # ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          echo "Running: $VENV_PYTHON $SCRIPT_PATH $ARGS"
          $VENV_PYTHON "$SCRIPT_PATH" $ARGS
        env:
          X_CONSUMER_KEY: ${{ secrets.X_CONSUMER_KEY }}
          X_CONSUMER_SECRET: ${{ secrets.X_CONSUMER_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

      - name: Notify Slack on failure
        if: failure()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          text="[SNSäºˆç´„æŠ•ç¨¿] âŒ æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ
          ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -sS -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H 'Content-type: application/json; charset=utf-8' \
            --data "$(jq -n --arg channel "$SLACK_CHANNEL_ID" --arg text "$text" '{channel:$channel,text:$text}')"

      - name: Notify Slack on success (if posted)
        if: success() && steps.post.outputs.posted == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          POST_TITLE: ${{ steps.post.outputs.title }}
          POST_URL: ${{ steps.post.outputs.url }}
          POST_COUNT: ${{ steps.post.outputs.count }}
        run: |
          if [ -n "$POST_URL" ]; then
            text="[SNSäºˆç´„æŠ•ç¨¿] âœ… æŠ•ç¨¿å®Œäº†
          ğŸ“ $POST_TITLE
          ğŸ”— $POST_URL"
          else
            text="[SNSäºˆç´„æŠ•ç¨¿] âœ… æŠ•ç¨¿å®Œäº†
          ğŸ“ $POST_TITLE (${POST_COUNT}ä»¶)"
          fi

          curl -sS -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H 'Content-type: application/json; charset=utf-8' \
            --data "$(jq -n --arg channel "$SLACK_CHANNEL_ID" --arg text "$text" '{channel:$channel,text:$text}')"
