---
name: ismp-vulnerability-check
description: ISMP/ISM脆弱性レポート（.docx）を解析し、DialogAI/SentryなどAWS上の対象システムに対する対応要否を判定し、根拠付きの一覧やレポートを更新する必要があるときに使う。
---

# ISMP Vulnerability Check

## 概要

ISMP/ISMのdocxから脆弱性一覧を抽出し、AWS上の対象システムに対して「対応要否」と根拠を判定し、レポート更新まで行う。

## ワークフロー

### 1. 入力条件を確認する

- 入力docxのパスを確定する
- 対象システム名（例: DialogAI / Sentry）とAWSプロファイル・リージョンを確認する
- 判定ルール（linuxにlinux-awsを含める等）を明示する

### 2. 脆弱性一覧を抽出する

`extract_ism_vulns.py` を使って一覧をTSV/JSONで抽出する。

```bash
python3 scripts/extract_ism_vulns.py \
  --input /path/to/ISMP_report.docx \
  --format tsv
```

出力カラム: `vuln_id`, `title`, `target_os`, `risk`, `cvss_v3`, `due`

### 3. 対象EC2を特定する

AWS CLIで名前/タグからDialogAI/Sentryのインスタンスを特定する。

```bash
aws ec2 describe-instances \
  --profile ncom --region ap-northeast-1 \
  --query 'Reservations[].Instances[].{InstanceId:InstanceId,Name:Tags[?Key==`Name`].Value|[0],PrivateIp:PrivateIpAddress,State:State.Name,Tags:Tags}' \
  --output json
```

必要に応じて `Name` や `Project=dialogai` などのタグで絞り込む。

### 4. OS/パッケージを確認する

SSMで以下を取得し、判定材料にする。

- `/etc/os-release`
- `uname -r`
- `dpkg-query` による主要パッケージの有無

例（AWS-RunShellScript）:

```bash
cat /etc/os-release
uname -r
for p in linux linux-aws linux-aws-5.15 linux-aws-6.8 linux-gkeop \
         linux-nvidia-tegra-igx python3-urllib3 python-urllib3 libpng16-16 libpng16-16t64; do
  dpkg-query -W -f='${Package}\t${Version}\n' "$p" 2>/dev/null || true
done
```

### 5. 対応要否を判定する

以下の判定ルールに従って「対応要否」と根拠を確定する。

- **OS不一致**: 対象外
- **linux**: linux-aws を含めて判定する
- **linux-aws-5.15 / linux-aws-6.8**: パッケージが存在しない場合は対象外
- **linux-gkeop / linux-nvidia-tegra-igx**: パッケージが存在しない場合は対象外
- **python-urllib3**: `python3-urllib3` が存在すれば対象
- **libpng1.6**: `libpng16-16` / `libpng16-16t64` を対象とみなす

### 6. レポートに反映する

- 2.1の表に「対応要否」と「対応要否の根拠」を必ず入れる
- 判定ルール（linuxはlinux-awsを含む等）を脚注で明示する
- 対象インスタンス一覧は最小限（DialogAI/Sentry）で十分

## 出力チェックリスト

- [ ] 脆弱性IDが重複排除されている
- [ ] 対象OSと実OSの突合ができている
- [ ] パッケージ一致の根拠が明記されている
- [ ] 「対応要否」と根拠が同一行に入っている

## Resources

### scripts/

- `extract_ism_vulns.py`: ISMP/ISM docxから脆弱性一覧を抽出する
